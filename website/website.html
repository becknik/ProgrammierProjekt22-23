<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Dijkstra Navigation</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
          integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
          crossorigin/>
    <link rel="stylesheet" href="style.css">

    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
            integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM="
            crossorigin></script>

    <script type="text/javascript" src="map-setup.js"></script>
    <!-- TODO <script type="text/javascript" src="website-interaction.js"></script> -->
</head>
<body>
<h1>Dijkstra Navigation</h1>

<div id="map" onload="setupMapContents()">It's a map</div>

<hr>

<h2>Coordinates</h2>
<p>Please enter your start and target coordinates below or just select points on the map.</p>

<div class="userInput">
    <label>Starting Point:</label>
    <input type="text" id="startingPoint">
    <input type="button" value="Set" onclick="setTextBox('startingPoint')"/>
</div>

<div class="userInput">
    <label>Target Point:</label>
    <input type="text" id="targetPoint">
    <input type="button" value="Set" onclick="setTextBox('targetPoint')"/>
</div>
<input type="button" value="Dijkstrulate" onclick="sendCoordinates()"><label id="infoMessage"></label>
<br>
<label id="AJAXResultTest"></label>
<br>

<script>


    // TODO find a way how to refactor this into another file...

    // Sets the starting view to Stuttgart
    const map = L.map('map').setView([48.783333, 9.183333], 11);

    // Calls function from map-setup.js to set up the basic map contents
    setupMapContents();

    let clicksLatitude;
    let clicksLongitude;


    // For map onclick popup action & global coords update
    function setGlobalVariableAndPopup(e) {

        clicksLongitude = e.latlng.lng;
        clicksLatitude = e.latlng.lat;

        L.popup()
            .setLatLng(e.latlng)
            .setContent("Longitude: " + clicksLongitude + "<br>Latitude: " + clicksLatitude)
            .openOn(map);
    }

    map.on('click', setGlobalVariableAndPopup);

    let startingPoint = new Array(2);
    let targetPoint = new Array(2);

    let startingMarker = new L.marker([48, 9]);
    let targetMarker = new L.marker(48, 9.5);

    // For setting textbox value to the with ID of textBoxID for button functionality
    function setTextBox(textBoxID) {
        const formattedCoords = String('(' + clicksLongitude + ", " + clicksLatitude + ')');

        const startingPointTextBox = document.getElementById(textBoxID);

        // TODO
        // const startPointTextBoxValue = startingPointTextBox.getAttribute("value");
        // Case: User entered some coords into text box
        // Case:  User did not change text box & maybe selected another point on the map?

        if (textBoxID === "startingPoint") {
            startingPoint[0] = clicksLongitude;
            startingPoint[1] = clicksLatitude;

            startingMarker.remove();
            startingMarker = L.marker([clicksLatitude, clicksLongitude])
                .addTo(map)
                .bindPopup('<b>Start Point</b>');

        } else if (textBoxID === "targetPoint") {
            targetPoint[0] = clicksLongitude;
            targetPoint[1] = clicksLatitude;
            
            targetMarker.remove();
            targetMarker=L.marker([clicksLatitude, clicksLongitude])
                .addTo(map)
                .bindPopup('<b>Target Point</b>');
        }

        startingPointTextBox.setAttribute("size", formattedCoords.length + "pt");
        startingPointTextBox.setAttribute("value", formattedCoords);
    }

    function sendCoordinates() {
        const messageFiled = document.getElementById("infoMessage");
        // Resetting previous error messages
        messageFiled.setAttribute("style","color:black");
        messageFiled.innerHTML = "";

        if (startingPoint != null && targetPoint != null) {
            // Maybe switch to jQuery?
            let request = new XMLHttpRequest();

            request.open("POST", "/src/main/java/server/MainServer.java"); // TODO Maybe use another name here
            request.setRequestHeader("Accept", "application/json");
            request.setRequestHeader("Accept", "utf-8");
            const jsonString = '{\n' +
                '"start": {\n' +
                '"long": ' + startingPoint[0] + ',\n' +
                '"lat": ' + startingPoint[1] + ',\n' +
                '},\n' +
                '"target": {\n' +
                '"long": ' + targetPoint[0] + ',\n' +
                '"lat": ' + targetPoint[1] + ',\n' +
                '}\n}';
            request.send(jsonString);


            request.onreadystatechange = function () {

                if ((request.status % 100) === 2) {
                    document.getElementById("AJAXResultTest").innerHTML = "Response received";
                    console.log(request.response);

                    var myLines = request.responseText;
                    //[{"coordinates":[[9.1623205,48.764806300000004],[9.1620649,48.7648591]],"type":"LineString"}]


                    var myStyle = {
                        "color": "#000000",
                        "weight": 1,
                        "opacity": 0.65
                    };

                    L.geoJSON(myLines, {
                        style: myStyle
                    }).addTo(map);

                } else {
                    console.log("ERROR:\tRequest returned status code " + request.status);
                }
            }
        } else {
            console.log("ERROR:\tCurrent coordinates are not defined.");

            messageFiled.setAttribute("style", "color:red");
            messageFiled.innerHTML = "<b>\tERROR:\tPlease set start & target point before Dijkstrulating!</b>";
        }
    }
</script>
</body>
</html>
