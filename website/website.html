<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Dijkstra Navigation</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
          integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
          crossorigin/>
    <link rel="stylesheet" href="style.css">

    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
            integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM="
            crossorigin></script>

    <script src="entities.js" type="text/javascript"></script>
    <script src="map-setup.js" type="text/javascript"></script>
    <script src="website-interaction.js" type="text/javascript"></script>
</head>
<body>
<h1 class="title">Dijkstra Navigation</h1>

<div id="map">It should be a map</div>

<h2 class="title">Coordinates</h2>
<p>Please select the target & source coordinates on the map.</p>

<div class="coordinatesSection">
    <label>Starting Point:</label><br>
    <div class="coordinateSet">
        <input type="text" id="startingPoint">
        <input type="button" value="Set" onclick="setTextBox('startingPoint')"/>
    </div>
</div>

<div class="coordinatesSection">
    <label>Target Point:</label><br>
    <div class="coordinateSet">
        <input type="text" id="targetPoint">
        <input type="button" value="Set" onclick="setTextBox('targetPoint')"/>
    </div>
</div>
<div style="text-align: center; margin-top: 3em">
    <input type="button" value="Dijkstrulate" class="sendButton" onclick="sendCoordinates()">
</div>

<hr style="margin-top: 1em; margin-bottom: 1em">

<h3 class="title">Settings</h3>
<label for="enableStarWars">
    <input type="checkbox" id="enableStarWars" onclick="switchTheme()">Enable Star Wars Theming
</label><br>
<label for="enableStarWars">
    <input type="checkbox" id="showCoordinatesPopup" onclick="toggleCoordinatePopup()">Enable Coordinates Popup on Selection
</label>


<hr style="margin-top: 2em; margin-bottom: 2em">

<div class="statusMessage">
    Server Status: <label id="serverStatusMessage" ></label>
    <input type="button" value="Refresh" onclick="getServerStatus()"><br>
    Website Status: <label id="websiteStatusMessage"></label>
</div>

<script>
    // Sets the starting view to Stuttgart
    const map = L.map('map').setView([48.783333, 9.183333], 11);

    // Calls function from map-setup.js to set up the basic map contents
    setupMapContents();

    document.addEventListener("DOMContentLoaded", getServerStatus);

    function getServerStatus() {
        const request = new XMLHttpRequest();
        request.open("GET", "ServerStatus");
        request.setRequestHeader("Accept", "text");
        request.setRequestHeader("Accept", "utf-8");
        request.send();

        request.onreadystatechange = function () {
            const serverStatusField = document.getElementById("serverStatusMessage");
            if ((request.status % 100) === 2) {
                serverStatusField.setAttribute("style", "color:green");
            } else {
                serverStatusField.setAttribute("style", "color:red");
                // TODO Periodical requests? Async server response?
            }
            serverStatusField.innerHTML = request.responseText;
        }
    }

    // -------------------------------------------------------------------------

    let clicksLatitude;
    let clicksLongitude;

    map.on('click', setGlobalVariableAndPopup);

    // For map onclick popup action & global coords update
    function setGlobalVariableAndPopup(e) {

        clicksLongitude = e.latlng.lng;
        clicksLatitude = e.latlng.lat;

        if (document.querySelector('#showCoordinatesPopup').checked) {
            L.popup()
                .setLatLng(e.latlng)
                .setContent("Longitude: " + clicksLongitude + "<br>Latitude: " + clicksLatitude)
                .openOn(map);
        } else {
            L.popup().setLatLng(e.latlng).setContent("Selection").openOn(map);
        }
    }

    // -------------------------------------------------------------------------

    let startingMarker = new L.marker();
    let targetMarker = new L.marker();

    let startingPoint = new Array(2);
    let targetPoint = new Array(2);

    let startIcon = defaultStartIcon;
    let targetIcon = defaultTargetIcon;

    function switchTheme() {
        if (document.querySelector('#enableStarWars').checked) {
            startIcon = emperorIcon;
            targetIcon = yodaIcon;

            uniStuttgart.remove();
            jediUniStuttgart.addTo(map)
                .bindPopup('<b>Universität Vaihingen</b>');

            janniksHome.remove();
            mustafaHome.addTo(map)
                .bindPopup('<b>Jannik\'s Home</b>');
        } else {
            startIcon = defaultStartIcon;
            targetIcon = defaultTargetIcon;

            jediUniStuttgart.remove();
            uniStuttgart.addTo(map)
                .bindPopup('<b>Universität Vaihingen</b>');
            mustafaHome.remove();
            janniksHome.addTo(map)
                .bindPopup('<b>Jannik\'s Home</b>');
        }
    }

    // For setting textbox value to the with ID of textBoxID for button functionality
    function setTextBox(textBoxID) {
        const formattedCoords = String('(' + clicksLongitude + ", " + clicksLatitude + ')');

        const startingPointTextBox = document.getElementById(textBoxID);

        if (textBoxID === "startingPoint") {
            startingPoint[0] = clicksLongitude;
            startingPoint[1] = clicksLatitude;

            startingMarker.remove();
            startingMarker = L.marker(
                [clicksLatitude, clicksLongitude], {icon: startIcon}
            )
                .addTo(map)
                .bindPopup('<b>Start Point</b>');

        } else if (textBoxID === "targetPoint") {
            targetPoint[0] = clicksLongitude;
            targetPoint[1] = clicksLatitude;

            targetMarker.remove();
            targetMarker = L.marker([clicksLatitude, clicksLongitude], {icon: targetIcon})
                .addTo(map)
                .bindPopup('<b>Target Point</b>');
        }

        startingPointTextBox.setAttribute("size", formattedCoords.length *.825 + "pt");
        startingPointTextBox.setAttribute("value", formattedCoords);
    }

    // -------------------------------------------------------------------------

    let geoJSONLayer = L.geoJSON().addTo(map);
    const serverStatusFiled = document.getElementById("serverStatusMessage");
    const websiteStausField = document.getElementById("websiteStatusMessage");

    function sendCoordinates() {
        // Resetting previous error messages
        websiteStausField.setAttribute("style", "color:black");
        websiteStausField.innerHTML = "";

        if (startingPoint[0] != null && targetPoint[0] != null) {
            let request = new XMLHttpRequest();

            request.open("PUT", "ShortestPath");
            request.setRequestHeader("Accept", "application/json");
            request.setRequestHeader("Accept", "utf-8");

            const jsonString = '{' +
                '"start": {' +
                '"long": ' + startingPoint[0] + ',' +
                '"lat": ' + startingPoint[1] + ',' +
                '},' +
                '"target": {' +
                '"long": ' + targetPoint[0] + ',' +
                '"lat": ' + targetPoint[1] + ',' +
                '}\n}';
            request.send(jsonString);

            request.onreadystatechange = function () {
                if ((request.status % 100) === 2) {
                    const shortestGeoJSONPath = JSON.parse(request.responseText);

                    var myStyle = {
                        "color": "#852bd9",
                        "weight": 3,
                        "opacity": 1
                    };
                    geoJSONLayer.remove();
                    geoJSONLayer = L.geoJSON(shortestGeoJSONPath, {
                        style: myStyle
                    }).addTo(map);
                } else {
                    console.log("ERROR:\tRequest returned status code " + request.status);
                    console.log(request.responseText);
                    serverStatusFiled.innerHTML = request.responseText;
                }
            }
        } else {
            const errorMessage = "ERROR:\tPlease set start & target point before Dijkstrulating!";

            websiteStausField.setAttribute("style", "color:red");
            websiteStausField.innerHTML = errorMessage;
            console.log(errorMessage);
        }
    }
</script>
</body>
</html>
